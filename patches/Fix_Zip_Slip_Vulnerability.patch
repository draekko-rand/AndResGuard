From aaa1175945414ef6a1d308d5f3af9b821fc9bdde Mon Sep 17 00:00:00 2001
From: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>
Date: Mon, 3 Oct 2022 21:29:15 +0000
Subject: [PATCH] vuln-fix: Zip Slip Vulnerability

This fixes a Zip-Slip vulnerability.

This change does one of two things. This change either

1. Inserts a guard to protect against Zip Slip.
OR
2. Replaces `dir.getCanonicalPath().startsWith(parent.getCanonicalPath())`, which is vulnerable to partial path traversal attacks, with the more secure `dir.getCanonicalFile().toPath().startsWith(parent.getCanonicalFile().toPath())`.

For number 2, consider `"/usr/outnot".startsWith("/usr/out")`.
The check is bypassed although `/outnot` is not under the `/out` directory.
It's important to understand that the terminating slash may be removed when using various `String` representations of the `File` object.
For example, on Linux, `println(new File("/var"))` will print `/var`, but `println(new File("/var", "/")` will print `/var/`;
however, `println(new File("/var", "/").getCanonicalPath())` will print `/var`.

Weakness: CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
Severity: High
CVSSS: 7.4
Detection: CodeQL (https://codeql.github.com/codeql-query-help/java/java-zipslip/) & OpenRewrite (https://public.moderne.io/recipes/org.openrewrite.java.security.ZipSlip)

Reported-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>
Signed-off-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>

Bug-tracker: https://github.com/JLLeitschuh/security-research/issues/16


Co-authored-by: Moderne <team@moderne.io>
---
 .../src/main/java/com/tencent/mm/util/FileOperation.java    | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/AndResGuard-core/src/main/java/com/tencent/mm/util/FileOperation.java b/AndResGuard-core/src/main/java/com/tencent/mm/util/FileOperation.java
index b022c795..62b0d998 100644
--- a/AndResGuard-core/src/main/java/com/tencent/mm/util/FileOperation.java
+++ b/AndResGuard-core/src/main/java/com/tencent/mm/util/FileOperation.java
@@ -160,7 +160,11 @@ public static HashMap<String, Integer> unZipAPk(String fileName, String filePath
         }
         BufferedInputStream bis = new BufferedInputStream(zipFile.getInputStream(entry));
 
-        File file = new File(filePath + File.separator + entry.getName());
+        File file = new File(filePath, entry.getName());
+
+        if (!file.toPath().normalize().startsWith(filePath)) {
+          throw new IOException("Bad zip entry");
+        }
 
         File parent = file.getParentFile();
         if (parent != null && (!parent.exists())) {
